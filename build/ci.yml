name: $(Build.Major).$(Build.Minor).$(date:yyMM).$(DayOfMonth)$(rev:rr)

variables:
  Build.Major: 0
  Build.Minor: 16
  Assembly.Version: $(Build.BuildNumber)
  Assembly.Constants: ''
  Drops.Dir: $(Build.ArtifactStagingDirectory)/drops
  Nuget.Outdir: $(Drops.Dir)/nugets
  VSIX.Outdir: $(Drops.Dir)/vsix
  Blobs.Outdir: $(Drops.Dir)/blobs
  Wheels.Outdir: $(Drops.Dir)/wheels

trigger: none

pr:
- main
- feature/*
- features/*
- release/*

schedules:
- cron: "0 9 * * Sat"
  displayName: 'Build for Component Governance'
  branches:
    include:
    - main
  always: true

jobs:
- job: Build
  variables:
  - name: Enable.Llvm.Builds
    value: false
  pool:
    vmImage: windows-latest
  steps:
  - template: init.yml
  - template: steps.yml
  - template: wrap-up.yml

- job: Style
  pool:
    vmImage: windows-latest
  steps:
  - script: dotnet tool restore
    displayName: Restore .NET tools

  - script: dotnet tool run fantomas -- --check --recurse .
    displayName: Fantomas


- job:
  strategy:
    matrix:
      linux:
        imageName: 'ubuntu-20.04'
      mac:
        imageName: 'macOS-10.14'
      windows:
        imageName: 'windows-2019'
  displayName: LLVM Based Components Build
  variables:
  - name: Enable.Compiler
    value: false
  - name: Enable.Vsix
    value: false
  - name: Enable.Llvm.Builds
    value: true
  pool:
    vmImage: $(imageName)
  steps:
  - script: |
      git submodule init
      git submodule update --depth 1 --recursive
    displayName: 'Checkout submodules'

  - template: init.yml

  - pwsh: ./build.ps1
    displayName: "Build all"
    workingDirectory: $(System.DefaultWorkingDirectory)/build

  - template: wrap-up.yml

